<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Higher Computing Science - Using Query Results</title>
        <script src="/JavaScript/higherScript.js"></script>
        <link rel="stylesheet" href="/CSS/sidebarStyles.css">
        <link rel="stylesheet" href="/CSS/styles.css">
        <link rel="stylesheet" href="/CSS/frameStyles.css">
        <style>
            .subheader th {background-color:lightgreen;}
        </style>
    </head>
    <body>
        <div id="loading"></div>
        <div id="mainContent" class="content-hidden">
        <header>
            <h1>BHS Computing Science</h1>
            <img src="/Images/Header/banner.png">
        </header>
        <div id="pageContainer">
            <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
            <div id="sidebar"></div>
            <div id="content">
                <div id="mainHeading"><h1>Higher</h1></div>
                <div class="contentHeading"><h1>Using Query Results</h1></div>
                <div class="contentContainer">
                    <p class="laws" onclick="toggleLaw(this)"><b>Example Database - used in Implementation Examples</b><span class="arrow">&#9654;</span></p>
                    <div class="law-content" style="display: none;">
                        <h3>Database Structure</h3>
                        <p>All of the examples in the implementation section will use the following database:</p>
                        <p>
                            <i>"A travel agency uses a relational database to enable thier employees to view details of hotels in Scottish holiday reosrts and make bookings 
                                for customers.  The details are stored in four separate tables called Hotel, Resort, Booking and Customer."</i>
                        </p>
                        <p>The structure of the tables is shown below:</p>
                        <img src="/Images/Higher/DDD/Design/resortEntities.JPG" alt="Resort Entities" class="cImg" width="50%"/>

                        <h3>Sample Records</h3>
                        <p>A sample record stored in each table is shown below:</p>
                        <img src="/Images/Higher/DDD/Implementation/resortRecords.jpg" alt="Resort Records" class="cImg" width="50%"/>

                        <p><b>
                            Note: These solutions have been tested in MS Access, therefore the wildcards used as ? and *.  The field 'customerID#' is enclosed in square 
                            brackets to avoid syntax errors.
                        </b></p>
                    </div>

                    <h2>Using the result of a Query</h2>
                    <p>
                        The result of stored query can be used within another query. The stored answer table is considered
                        as a table by the database engine and any value generated by the query can be used as part of the
                        <span class="codeTEXT">WHERE</span> clause in a second query. This is especially useful when working with aggregate functions.
                    </p>
                    <h3>Example 1</h3>
                    <p>
                        The queries below is used to display the name of the resorts that have hotels with the highest star rating
                        together with the highest star rating (use a readable heading to display the highest star rating).
                    </p>

                    <p><b><u>Query 1 - Find Maximum Rating</u></b></p>
                    <div class="codeBox">
                        <p>SELECT MAX(starRating) AS [Highest Rating]</p>
                        <p>FROM Hotel;</p>
                    </div>
                    
                    <p><b><u>Query 2 - Display Names of Resorts with Maximum Rating</u></b></p>
                    <div class="codeBox">
                        <p>SELECT resortName AS [Resorts with Highest Rated Hotels], [Highest Rating]</p>
                        <p>FROM Resort, Hotel, [Find Maximum Rating]</p>
                        <p>WHERE Resort.resortID = Hotel.resortID</p>
                        <p>AND starRating = [Highest Rating];</p>
                    </div>

                    <p>
                        A subclause may be used to combine the two queries. Using subclauses is beyond the scope of the
                        Higher course and will not be assessed. However, it may be useful to help to understand how the
                        result of a query can be used within another query. The SQL statement below demonstrates using an
                        aggregate function as part of a condition, allowing the selection of all records that match the
                        maximum rating.
                    </p>

                    <div class="codeBox">
                        <p>SELECT resortName AS [Resorts with Highest Rated Hotels]</p>
                        <p>FROM Resort, Hotel</p>
                        <p>WHERE Resort.resortID = Hotel.resortID</p>
                        <p>AND starRating = (SELECT MAX(starRating) FROM Hotel;);</p>
                    </div>

                    <h2>Example 2</h2>
                    <p>
                        The queries below are used to display details of any hotel with a price per person that is below the average
                        price per person. The query should display the hotel name, star rating, meal plan and the price per
                        night. The dearest hotel should be listed first.
                    </p>

                    <p><b><u>Query 1 - Find Average Per Person</u></b></p>
                    <div class="codeBox">
                        <p>SELECT ROUND(AVG(pricePersonNight), 2) AS [Average Price per Person (£)]</p>
                        <p>FROM Hotel;</p>
                    </div>

                    <p><b><u>Query 2 - Display Details of Hotels with Price Per Person Below Average</u></b></p>
                    <div class="codeBox">
                        <p>SELECT hotelName, starRating, mealPlan, [Average Price per Person (£)]</p>
                        <p>FROM Hotel, [Find Average Per Person]</p>
                        <p>WHERE pricePersonNight &lt; [Average Price per Person (£)]</p>
                        <p>ORDER BY pricePersonNight DESC;</p>
                    </div>
                    
                    <h2>Past Paper Question - 2022 Q11</h2>
                    <p>
                        Perfect Eyes is an optician that has branches throughout Scotland. It uses a 
                        relational database consisting of three linked tables to store data about customers, 
                        opticians and specialist referrals.
                    </p>
                    <p>
                        Extracts from the three tables are shown below.
                    </p>
                    <table>
                        <tr><th colspan="7">Customer</th></tr>
                        <tr class="subheader"><th>customerID</th><th>opticianID</th><th>forename</th><th>surname</th><th>loyaltyPoints</th><th>address</th><th>town</th></tr>
                        <tr><td>AW3212</td><td>KM101</td><td>Amy</td><td>Wilson</td><td>24</td><td>8 Pelken Road</td><td>Paisley</td></tr>
                        <tr><td>JP2323</td><td>CS878</td><td>Joyce</td><td>Peden</td><td>47</td><td>42 Bewston Road</td><td>Ayr</td></tr>
                        <tr><td>JS9767</td><td>KM101</td><td>Julia</td><td>Smith</td><td>77</td><td>32 Bracken Road</td><td>Paisley</td></tr>
                        <tr><td>KC1123</td><td>MS221</td><td>Katy</td><td>Carenduff</td><td>11</td><td>12 Main Street</td><td>Melrose</td></tr>
                        <tr><td>LL3234</td><td>CS878</td><td>Robin</td><td>Li</td><td>51</td><td>21 Manse Court</td><td>Largs</td></tr>
                        <tr><td>MR8766</td><td>JS232</td><td>Margaret</td><td>Rennie</td><td>73</td><td>63 Royal Crescent</td><td>Dairy</td></tr>
                        <tr><td>SR7123</td><td>CS878</td><td>Steven</td><td>Rycroft</td><td>50</td><td>22 Markson Place</td><td>Ayr</td></tr>
                        <tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                    </table>

                    <table style="max-width:600px">
                        <tr><th colspan="4">Optician</th></tr>
                        <tr class="subheader"><th>opticianID</th><th>opticianName</th><th>opticianAddress</th><th>opticianTown</th></tr>
                        <tr><td>KM101</td><td>Mr K Madhok</td><td>South Road</td><td>Paisley</td></tr>
                        <tr><td>KM321</td><td>Mr M Ali</td><td>Main Road</td><td>Troon</td></tr>
                        <tr><td>MS221</td><td>Mrs M Saunders</td><td>St Dunstan's Park</td><td>Melrose</td></tr>
                        <tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                    </table>

                    <table style="max-width:600px">
                        <tr><th colspan="4">Referral</th></tr>
                        <tr class="subheader"><th>referralID</th><th>customerID</th><th>referralDate</th><th>specialist</th></tr>
                        <tr><td>P12121</td><td>AW3212</td><td>12/02/2022</td><td>Gerard McGowan Eye Clinic</td></tr>
                        <tr><td>H92743</td><td>HS3433</td><td>14/02/2022</td><td>JK Optometrist</td></tr>
                        <tr><td>CXR222</td><td>JP2323</td><td>28/04/2022</td><td>Eye Clinic at Newmains</td></tr>
                        <tr><td>U32349</td><td>JS9767</td><td>26/04/2022</td><td>Gerard McGowan Eye Clinic</td></tr>
                        <tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                    </table>
                    <table>
                        <tr>
                            <th rowspan="2" width="30px">(b)(i)</th>
                            <td>
                                <p>
                                    Perfect Eyes wants to know which customers have more than the average 
                                    loyalty points.
                                </p>
                                <p>
                                    Write the SQL statement to display the average loyalty points of the 
                                    customers, as shown below.
                                </p>
                                <table style="max-width: 200px;">
                                    <tr><th>Average Loyalty Points</th></tr>
                                    <tr><td>38.4</td></tr>
                                </table>
                            </td>
                            <th rowspan="2"  width="30px">2</th>
                        </tr>
                            <tr>
                                <td>
                                    <div class="hiddenElement answer1">
                                        <div class="codeBox">
                                            <p>SELECT ROUND(AVG(loyaltyPoints), 1) AS [Average Loyalty Points]</p>
                                            <p>FROM Customer;</p>
                                        </div>
                                        <hr>
                                        <p>One mark for each bullet:</p>
                                        <ul>
                                            <li>aggregate function AVG on loyaltyPoints</li>
                                            <li>alias and table</li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    <div class="answerButton" onClick="answerButtonSwitch(this); toggleVisibility('answer1')">Show Answer</div>

                    <table>
                        <tr>
                            <th rowspan="2" width="30px">(b)(ii)</th>
                            <td>
                                <p>
                                    The query from part (i) is saved as ‘AvgPointsQuery’. Using this query, 
                                    complete the SQL statement to display the customers who have more than 
                                    the average loyalty points, in order from highest to lowest as shown below.
                                </p>
                                <table style="max-width:600px;">
                                    <tr><th>forename</th><th>surname</th><th>loyaltyPoints</th><th>opticianName</th></tr>
                                    <tr><td>Julia</td><td>Smith</td><td>77</td><td>Mr K Madhok</td></tr>
                                    <tr><td>Margaret</td><td>Rennie</td><td>73</td><td>Mr J Stewart</td></tr>
                                    <tr><td>Robin</td><td>Li</td><td>51</td><td>Miss C Srigor</td></tr>
                                    <tr><td>Steven</td><td>Rycroft</td><td>50</td><td>Miss C Srigor</td></tr>
                                    <tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                                </table>
                            </td>
                            <th rowspan="2"  width="30px">1</th>
                        </tr>
                            <tr>
                                <td>
                                    <div class="hiddenElement answer1">
                                        <div class="codeBox">
                                            <p>SELECT forename, surname, loyaltyPoints, opticianName</p>
                                            <p>FROM Customer, Optician, AvgPointsQuery</p>
                                            <p>WHERE Customer.opticianID = Optician.opticianID AND loyaltyPoints &gt; [Average Loyalty Points]</p>
                                            <p>ORDER BY loyaltyPoints DESC;</p>
                                        </div>
                                        <hr>
                                        <p>One mark for each bullet:</p>
                                        <ul>
                                            <li>FROM Customer, Optician, AvgPointsQuery</li>
                                            <li>Equi-join: WHERE Customer.opticianID = Optician.opticianID</li>
                                            <li>loyaltyPoints &gt; [Average Loyalty Points]</li>
                                            <li>loyaltyPoints ordered in descending order</li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    <div class="answerButton" onClick="answerButtonSwitch(this); toggleVisibility('answer1')">Show Answer</div>
                    
                </div>
            </div>
        </div>
        <footer>
            <div id="left">
                <p>Biggar High School</p>
                <p>Market Rd, Biggar</p>
                <p>ML12 6AG</p>
            </div>
            <div id="center"></div>
            <div id="right">
                <p>&copy;C Dunn, 2025</p>
            </div>
        </footer>
        </div>
    </body>
</html>